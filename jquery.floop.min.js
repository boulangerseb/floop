/*
 *  Project: floop
 *  Description: A jQuery plugin to display a frames sequence as a browsable animation. Mainly used to simulate 3D roation in a browser.
 *  Author: SÃ©bastien Boulanger
 *  License: Creative Commons
 *  Version: 0.5.2
 */
(function(e,t,n,r){function o(t,n){this.element=e(t);this.options=e.extend({},s,n);this.truc="blah";this._defaults=s;this._name=i;this.filename={complete:"",path:"",extension:"",noextension:"",sequence:"",number:0,name:""};this.minPic=0;this.maxPic=0;this.numOfPics=0;this.dimensions={width:0,height:0};this.jmlContainer="";this.jmlImages="";this.jmlDragIcon="";this.jmlStatusBar="";this.jmlProgressBar="";this.jmlProgressValue="";this.progress=0;this.autoplayItv=null;this.autoplayRepeats=0;this.locked=false;this.init()}var i="floop",s={range:"0-100",steps:1,reverse:false,callToAction:true,className:"",autoplay:{speed:25,repeat:"infinity",locked:true},onLoad:null,onComplete:null};o.prototype={init:function(){this.execFloop()},execFloop:function(){this.dimensions.width=this.element.get(0).width;this.dimensions.height=this.element.get(0).height;this.minPic=parseInt(this.options.range.slice(0,1+this.options.range.indexOf("-")));this.maxPic=parseInt(this.options.range.slice(1+this.options.range.indexOf("-"),this.options.range.length));this.numOfPics=Math.ceil(this.maxPic/this.options.steps);this.setFilename();this.prepareHtml();this.bindTriggers();this.loadPictures()},prepareHtml:function(){this.element.css({position:"relative",zIndex:"1"});this.jmlContainer=e('<div class="floop_container '+this.options.className+'" style="overflow:hidden;width:'+this.dimensions.width+"px;height:"+this.dimensions.height+'px;"></div>');this.jmlImages=e('<div class="floop_images" style="overflow:hidden;width:'+this.dimensions.width+"px;height:"+this.dimensions.height+'px;"></div>');this.element.wrap(this.jmlImages);this.jmlImages=e(this.element.parent());this.jmlImages.wrap(this.jmlContainer);this.jmlContainer=e(this.jmlImages.parent());this.jmlStatusBar=e('<div style="width:'+this.dimensions.width+'px;" class="floop_status"></div>');this.jmlImages.after(this.jmlStatusBar);this.jmlProgressValue=e('<div style="width:0%;" class="floop_progress_value"></div>');this.jmlProgressBar=e('<div class="floop_progress"></div>');this.jmlStatusBar.append(this.jmlProgressBar);this.jmlProgressBar.append(this.jmlProgressValue);this.jmlDragIcon=e('<div style="margin-top:'+(this.dimensions.height/2-11)+"px;margin-left:"+(this.dimensions.width/2-15)+'px;" class="floop_drag_icon"></div>')},bindTriggers:function(){this.element.bind("play",e.proxy(function(){this.startAutoplay()}),this);this.element.bind("stop",e.proxy(function(){this.startAutoplay()}),this);this.element.bind("next",e.proxy(function(){this.startAutoplay()}),this);this.element.bind("prev",e.proxy(function(){this.startAutoplay()}),this)},animateDragIcon:function(){this.jmlDragIcon.animate({marginLeft:"-=2px"},200).animate({marginLeft:"+=2px"},200,e.proxy(function(){this.animateDragIcon()},this))},setFilename:function(){regSequence=new RegExp("[0-9]+$");regFilenumber=new RegExp("^0*");this.filename.complete=this.element.attr("src").slice(1+this.element.attr("src").lastIndexOf("/"),this.element.attr("src").length);this.filename.path=this.element.attr("src").slice(0,1+this.element.attr("src").lastIndexOf("/"));this.filename.extension=this.filename.complete.slice(1+this.filename.complete.lastIndexOf("."),this.filename.complete.length);this.filename.noextension=this.filename.complete.slice(0,this.filename.complete.lastIndexOf("."));this.filename.sequence=this.filename.noextension.match(regSequence)[0];this.filename.number=parseInt(this.filename.sequence.replace(regFilenumber,""));this.filename.number=this.filename.number?this.filename.number:0;this.filename.name=this.filename.noextension.slice(0,this.filename.noextension.lastIndexOf(this.filename.sequence))},loadPictures:function(){var t="";var n="0";var r="";var i=[];var s="";for(var o=0;o<=this.numOfPics;o++){t=""+(this.minPic+o*this.options.steps);while(t.length<this.filename.sequence.length){t=n.concat(t)}s=this.filename.path+this.filename.name+t+"."+this.filename.extension;r=e('<img style="display:none;" />');r.attr("src",s).on("load",e.proxy(function(e){i.push(e.currentTarget);this.progress++;this.incrementLoad();if(this.progress===this.numOfPics){this.appendPictures(i)}},this))}},appendPictures:function(t){this.jmlStatusBar.remove();for(var n=0;n<=this.numOfPics;n++){var r=t[n];var i="";var s="0";i=""+(this.minPic+n*this.options.steps);while(i.length<this.filename.sequence.length){i=s.concat(i)}file=this.filename.path+this.filename.name+i+"."+this.filename.extension;for(var o=0;o<=this.numOfPics;o++){if(e(t[o]).attr("src")===file){if(-1!=e(t[o]).attr("src").indexOf(this.element.attr("src"))){this.jmlImages.append(this.element)}else{this.jmlImages.append(t[o])}}}}this.options.callToAction?this.jmlImages.before(this.jmlDragIcon):null;this.animateDragIcon();this.setControls()},incrementLoad:function(){this.jmlProgressValue.css("width",Math.ceil(this.progress/this.numOfPics*100)+"%")},setControls:function(){this.jmlImages.on("mouseover",e.proxy(function(t){this.jmlDragIcon.remove();e(t.currentTarget).off("mouseover")},this));var t=0;this.jmlImages.draggable({iframeFix:true,grid:[999999,999999],drag:e.proxy(function(e,n){if(!this.options.autoplay.locked){this.stopAutoplay()}if(t>e.originalEvent.pageX){if(0===e.originalEvent.pageX%3){this.options.reverse?this.displayNext():this.displayPrev()}}if(t<e.originalEvent.pageX){if(0===e.originalEvent.pageX%3){this.options.reverse?this.displayPrev():this.displayNext()}}t=e.originalEvent.pageX},this)});if(this.options.autoplay){this.startAutoplay()}},startAutoplay:function(){if(this.options.autoplay.locked){this.locked="true"}this.options.autoplay.speed=this.options.autoplay.speed?this.options.autoplay.speed:25;this.options.autoplay.repeat=this.options.autoplay.repeat?this.options.autoplay.repeat:1;var t=Math.ceil(1e3/this.options.autoplay.speed);var n=0;if("infinity"!==this.options.autoplay.repeat){n=this.options.autoplay.repeat*this.numOfPics+Math.ceil(this.filename.number/this.options.steps)}this.autoplayItv=setInterval(e.proxy(function(){if("infinity"===this.options.autoplay.repeat||n>=this.autoplayRepeats){this.autoplayRepeats++;this.options.reverse?this.displayPrev(true):this.displayNext(true)}else{this.stopAutoplay()}},this),t)},stopAutoplay:function(){this.autoplayRepeats=0;clearInterval(this.autoplayItv);this.autoplayItv=null;this.locked=false},displayPrev:function(e){if(e||!this.locked){if(this.element.prev().get(0)){this.element.css("display","none");this.element.prev().css("display","block");this.element=this.element.prev()}else{this.element.css("display","none");this.jmlImages.find("img:last-child").css("display","block");this.element=this.jmlImages.find("img:last-child")}}},displayNext:function(e){if(e||!this.locked){if(this.element.next().get(0)){this.element.css("display","none");this.element.next().css("display","block");this.element=this.element.next()}else{this.element.css("display","none");this.jmlImages.find("img:first-child").css("display","block");this.element=this.jmlImages.find("img:first-child")}}}};e.fn[i]=function(t){return this.each(function(){if(!e.data(this,"plugin_"+i)){e.data(this,"plugin_"+i,new o(this,t))}})}})(jQuery,window,document)