/*
 *  Project: floop
 *  Description: A jQuery plugin to display a frames sequence as a browsable animation. Mainly used to simulate 3D roation in a browser.
 *  Author: SÃ©bastien Boulanger
 *  License: Creative Commons
 */
(function(e,t,n,r){function o(t,n){this.element=t;this.options=e.extend({},s,n);this._isTouch=false;this._defaults=s;this._name=i;this._filename={complete:"",path:"",extension:"",noextension:"",sequence:"",number:0,name:""};this._minPic=0;this._maxPic=0;this._numOfPics=0;this._dimensions={width:0,height:0};this._container="";this._statusBar="";this._progressBar="";this._progressValue="";this._visibleImg=e(this.element);this._progress=0;this.init()}var i="floop",s={range:"0-100",steps:1};o.prototype={init:function(){var t=this;if(0===this.element.width||0===this.element.height){e.ajax(this.element.src).done(function(e){t._dimensions.width=t.element.width;t.execFloop(t)})}else{this.execFloop(t)}},execFloop:function(e){this.isTouch=this.isTouchDevice();this._dimensions.width=this.element.width;this._dimensions.height=this.element.height;this._minPic=parseInt(this.options.range.slice(0,1+this.options.range.indexOf("-")));this._maxPic=parseInt(this.options.range.slice(1+this.options.range.indexOf("-"),this.options.range.length));this._numOfPics=Math.ceil(this._maxPic/this.options.steps);this.setFilename();this.prepareHtml();this.loadPictures(e)},isTouchDevice:function(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)){return true}else{return false}},prepareHtml:function(){e(this.element).css({position:"relative",zIndex:"1"});this._container=e('<div class="floop_container" style="overflow:hidden;width:'+this._dimensions.width+"px;height:"+this._dimensions.height+'px;"></div>');e(this.element).wrap(this._container);this._statusBar=e('<div style="width:'+this._dimensions.width+'px;" class="floop_status"></div>');e(this.element).parent().after(this._statusBar);this._progressValue=e('<div style="width:0%;" class="floop_progress_value"></div>');this._progressBar=e('<div class="floop_progress"></div>');this._statusBar.append(this._progressBar);this._progressBar.append(this._progressValue)},setFilename:function(){regSequence=new RegExp("[0-9]+$");regFilenumber=new RegExp("^0*");this._filename.complete=this.element.src.slice(1+this.element.src.lastIndexOf("/"),this.element.src.length);this._filename.path=this.element.src.slice(0,1+this.element.src.lastIndexOf("/"));this._filename.extension=this._filename.complete.slice(1+this._filename.complete.lastIndexOf("."),this._filename.complete.length);this._filename.noextension=this._filename.complete.slice(0,this._filename.complete.lastIndexOf("."));this._filename.sequence=this._filename.noextension.match(regSequence)[0];this._filename.number=parseInt(this._filename.sequence.replace(regFilenumber,""));this._filename.name=this._filename.noextension.slice(0,this._filename.noextension.lastIndexOf(this._filename.sequence))},loadPictures:function(t){var n="";var r="0";var i="";var s=[];var o="";for(var u=0;u<=this._numOfPics;u++){n=""+(this._minPic+u*this.options.steps);while(n.length<this._filename.sequence.length){n=r.concat(n)}o=this._filename.path+this._filename.name+n+"."+this._filename.extension;i=e('<img style="display:none;" />');i.attr("src",o).load(function(){if(!this.complete||typeof this.naturalWidth=="undefined"||this.naturalWidth==0){console.log("Something wrong happens : "+o)}else{s.push(this)}t.incrementLoad();if(t._progress==t._numOfPics){t.appendPictures(s,t)}else{t._progress++}})}},appendPictures:function(t,n){this._statusBar.remove();for(var r=0;r<=this._numOfPics;r++){var i=t[r];var s="";var o="0";s=""+(this._minPic+r*this.options.steps);while(s.length<this._filename.sequence.length){s=o.concat(s)}file=this._filename.path+this._filename.name+s+"."+this._filename.extension;for(var u=0;u<=this._numOfPics;u++){if(e(t[u]).attr("src")==file){if(-1!=e(t[u]).attr("src").indexOf(e(this.element).attr("src"))){e(this.element).parent().append(e(this.element))}else{e(this.element).parent().append(t[u])}}}}this.setControls(n)},incrementLoad:function(){this._progressValue.css("width",Math.ceil(this._numOfPics/this._progress*100)+"%")},setControls:function(t){var r=0;e(t.element).parent().draggable({iframeFix:true,grid:[9e5,9e5],drag:function(e,n){if(r>e.originalEvent.pageX){if(0==e.originalEvent.pageX%3){t.displayNext(t)}}if(r<e.originalEvent.pageX){if(0==e.originalEvent.pageX%3){t.displayPrev(t)}}r=e.originalEvent.pageX}});e(n).on("keydown",function(e){switch(e.which){case 37:t.displayPrev(t);break;case 39:t.displayNext(t);break}})},displayPrev:function(e){if(e._visibleImg.prev().get(0)){e._visibleImg.css("display","none");e._visibleImg.prev().css("display","block");e._visibleImg=e._visibleImg.prev()}else{e._visibleImg.css("display","none");e._visibleImg.parent().find("img:last-child").css("display","block");e._visibleImg=e._visibleImg.parent().find("img:last-child")}},displayNext:function(e){if(e._visibleImg.next().get(0)){e._visibleImg.css("display","none");e._visibleImg.next().css("display","block");e._visibleImg=e._visibleImg.next()}else{e._visibleImg.css("display","none");e._visibleImg.parent().find("img:first-child").css("display","block");e._visibleImg=e._visibleImg.parent().find("img:first-child")}}};e.fn[i]=function(t){return this.each(function(){if(!e.data(this,"plugin_"+i)){e.data(this,"plugin_"+i,new o(this,t))}})}})(jQuery,window,document)